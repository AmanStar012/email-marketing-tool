<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Email Marketing Tool - Account System</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px;color:#333
    }
    .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:24px;
      box-shadow:0 30px 60px rgba(0,0,0,.1);overflow:hidden;backdrop-filter:blur(10px)}
    .header{background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%);color:#fff;padding:30px;text-align:center;position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
      background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);animation:pulse 4s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:.5}50%{transform:scale(1.05);opacity:.8}}
    .header h1{font-size:2.5em;margin-bottom:10px;font-weight:700;position:relative;z-index:1}
    .header p{font-size:1.1em;opacity:.9;position:relative;z-index:1}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:30px;position:relative;z-index:1}
    .stat-card{background:rgba(255,255,255,.15);padding:20px;border-radius:16px;text-align:center;
      backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);transition:transform .3s ease}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-number{font-size:2.5em;font-weight:700;display:block;margin-bottom:5px}
    .stat-label{font-size:.9em;opacity:.9}

    .main-content{display:grid;grid-template-columns:1fr 1fr;gap:30px;padding:40px}
    .section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.05);
      border:1px solid rgba(0,0,0,.05);transition:transform .3s ease,box-shadow .3s ease}
    .section:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
    .section-header{display:flex;align-items:center;margin-bottom:25px;gap:15px}
    .section-icon{width:40px;height:40px;background:linear-gradient(135deg,#3498db,#2980b9);border-radius:12px;
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;font-weight:600}
    .section-title{font-size:1.4em;font-weight:600;color:#2c3e50}

    .upload-zone{border:3px dashed #3498db;border-radius:16px;padding:40px;text-align:center;
      background:linear-gradient(135deg,#f8f9ff,#e3f2fd);transition:all .3s ease;cursor:pointer}
    .upload-zone:hover{border-color:#2980b9;transform:scale(1.02)}

    .btn{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;padding:12px 24px;border-radius:10px;
      cursor:pointer;font-size:14px;font-weight:600;transition:all .3s ease;display:inline-flex;align-items:center;gap:8px}
    .btn-success{background:linear-gradient(135deg,#27ae60,#229954)}
    .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .btn-secondary{background:linear-gradient(135deg,#6c757d,#5a6268)}
    .btn-small{padding:8px 16px;font-size:12px}

    .email-accounts{display:grid;gap:20px}
    .email-account{background:#f8f9fa;padding:20px;border-radius:12px;border:2px solid #e9ecef}
    .email-account.connected{border-color:#27ae60}
    .email-account.disconnected{border-color:#e74c3c}

    .progress-container{padding:30px;background:#fff;margin:20px;border-radius:16px}
    .progress-bar{width:100%;height:12px;background:#e9ecef;border-radius:6px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#3498db,#2980b9);width:0%}

    .log-area{background:#2c3e50;color:#ecf0f1;padding:20px;border-radius:12px;font-family:monospace;font-size:13px;max-height:300px;overflow-y:auto}
    .log-entry{margin-bottom:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ Email Marketing Pro</h1>
      <p>Manual + Auto Hourly Campaign</p>
      <div class="stats-grid">
        <div class="stat-card"><span class="stat-number" id="totalSent">0</span><span class="stat-label">Emails Sent</span></div>
        <div class="stat-card"><span class="stat-number" id="successRate">0%</span><span class="stat-label">Success Rate</span></div>
        <div class="stat-card"><span class="stat-number" id="inQueue">0</span><span class="stat-label">In Queue</span></div>
        <div class="stat-card"><span class="stat-number" id="failedCount">0</span><span class="stat-label">Failed</span></div>
      </div>
    </div>

    <div class="main-content">
      <div class="left-column">
        <div class="section">
          <div class="section-header">
            <div class="section-icon">1</div>
            <div class="section-title">Upload Contacts</div>
          </div>
          <div class="upload-zone" id="uploadZone">
            <input type="file" id="csvInput" accept=".csv" style="display:none;">
            <button class="btn btn-small" onclick="document.getElementById('csvInput').click()">üìÅ Choose File</button>
          </div>
          <div id="contactsPreview"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <div class="section-icon">2</div>
            <div class="section-title">Email Template + Auto</div>
          </div>

          <input class="form-control" id="brandName" placeholder="Brand Name">
          <input class="form-control" id="templateName" placeholder="Template Name">
          <input class="form-control" id="subjectLine" placeholder="Subject Line">
          <textarea class="form-control" id="emailContent" placeholder="Email body"></textarea>

          <div class="auto-box">
            <button class="btn btn-success" id="autoStartBtn">Start Auto</button>
            <button class="btn btn-danger" id="autoStopBtn">Stop Auto</button>
            <div id="autoStatusBox">Auto Status: idle</div>
            <div id="autoLiveBox"></div>
          </div>
        </div>
      </div>

      <div class="right-column">
        <div class="section">
          <div class="section-header">
            <div class="section-icon">3</div>
            <div class="section-title">Manual Campaign</div>
          </div>
          <button class="btn btn-success" id="startCampaign">Launch Manual</button>
        </div>

        <div class="section">
          <div class="section-header">
            <div class="section-icon">4</div>
            <div class="section-title">Email Accounts</div>
          </div>
          <div class="email-accounts" id="emailAccounts"></div>
        </div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="log-area" id="logArea"></div>
    </div>
  </div>

<script>


const state = {
  contacts: [],
  emailAccounts: [],
  stats: { totalSent: 0, failed: 0, inQueue: 0, successRate: 0 }
};

class API {
  async getAccounts() {
    const r = await fetch('/api/accounts');
    return (await r.json()).accounts || [];
  }
  async autoStatus() {
    const r = await fetch('/api/auto-status');
    return await r.json();
  }
  async autoStart(payload) {
    return fetch('/api/auto-start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }
  async autoStop() {
    return fetch('/api/auto-stop', { method: 'POST' }).then(r => r.json());
  }
}

const api = new API();


async function refreshAccountsRealtime() {
  try {
    const accounts = await api.getAccounts();
    state.emailAccounts = accounts;
    renderAccounts();
  } catch {}
}

/* refresh every 3 seconds */
setInterval(refreshAccountsRealtime, 3000);


async function refreshAutoStatus() {
  try {
    const s = await api.autoStatus();
    if (!s || !s.campaign) return;

    const c = s.campaign;
    document.getElementById('autoStatusBox').innerHTML =
      `Status: <b>${c.status}</b><br>
       Progress: ${c.cursor}/${c.total}`;

    document.getElementById('progressFill').style.width =
      `${Math.round((c.cursor / c.total) * 100)}%`;

    state.stats.totalSent = s.stats?.totalSent || 0;
    state.stats.failed = s.stats?.totalFailed || 0;
    state.stats.inQueue = Math.max(0, c.total - c.cursor);
    state.stats.successRate =
      (state.stats.totalSent + state.stats.failed) > 0
        ? Math.round((state.stats.totalSent / (state.stats.totalSent + state.stats.failed)) * 100)
        : 0;

    updateStats();

  } catch {}
}

setInterval(refreshAutoStatus, 2000);

/* =========================
   UI RENDERING
   ========================= */

function renderAccounts() {
  const wrap = document.getElementById('emailAccounts');
  wrap.innerHTML = '';

  state.emailAccounts.forEach(acc => {
    const div = document.createElement('div');
    div.className = `email-account ${acc.connected ? 'connected' : 'disconnected'}`;
    div.innerHTML = `
      <b>${acc.email}</b><br>
      <small>${acc.senderName || ''}</small><br>
      <span>${acc.connected ? '‚úÖ Connected' : '‚ùå Disconnected'}</span>
    `;
    wrap.appendChild(div);
  });
}

function updateStats() {
  document.getElementById('totalSent').textContent = state.stats.totalSent;
  document.getElementById('failedCount').textContent = state.stats.failed;
  document.getElementById('inQueue').textContent = state.stats.inQueue;
  document.getElementById('successRate').textContent = state.stats.successRate + '%';
}

/* =========================
   AUTO START / STOP
   ========================= */

document.getElementById('autoStartBtn').onclick = async () => {
  const payload = {
    contacts: state.contacts,
    template: {
      subject: document.getElementById('subjectLine').value,
      content: document.getElementById('emailContent').value
    },
    perEmailDelayMs: 1000,
    parallelAccounts: 10
  };
  await api.autoStart(payload);
};

document.getElementById('autoStopBtn').onclick = async () => {
  await api.autoStop();
};

/* =========================
   CSV BASIC LOAD (SAFE)
   ========================= */

document.getElementById('csvInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => {
    const lines = ev.target.result.split('\n').slice(1);
    state.contacts = lines.map(l => {
      const [email] = l.split(',');
      return { email };
    }).filter(c => c.email);
    state.stats.inQueue = state.contacts.length;
    updateStats();
  };
  r.readAsText(file);
});


refreshAccountsRealtime();
refreshAutoStatus();

</script>
</body>
</html>
